tasks:
  prebuild:
    linux:
      steps:
        - echo "Prebuild (linux)"
        - build_common
    macos:
      steps:
        - echo "Prebuild (macos)"
        - build_common
    windows:
      steps:
        - echo Prebuild (windows)
        - build_common

  build:
    linux: &cargo_build
      steps:
        - cargo build --release
    macos: *cargo_build
    windows: *cargo_build

  test:
    linux: &test_steps
      steps:
        - test_cargo
    macos: *test_steps
    windows: *test_steps

  predeploy:
    linux:
      steps:
        - mkdir -p dist
        - test -f "target/release/${BIN}" || { echo "missing target/release/${BIN}. Did you run build?"; exit 1; }
        - cp "target/release/${BIN}" "dist/${BIN}"
        - echo "Packaged ${BIN} ${VERSION} -> dist/"
      config: &predeploy_config
        env:
          VERSION: "0.1.0"
    macos:
      steps:
        - mkdir -p dist
        - test -f "target/release/${BIN}" || { echo "missing "target/release/${BIN}". Run build first."; exit 1; }
        - cp "target/release/${BIN}" "dist/${BIN}"
        - (command -v strip >/dev/null 2>&1 && strip -x "dist/${BIN}") || true
        - echo "Packaged ${BIN} ${VERSION} -> dist/"
      config: *predeploy_config
    windows:
      steps:
        - powershell -Command "New-Item -ItemType Directory -Force -Path dist | Out-Null"
        - powershell -Command 'if (!(Test-Path "target\release\$env:BIN.exe")) { throw "missing target\release\$env:BIN.exe. Run build first." }'
        - powershell -Command "Copy-Item target\release\$env:BIN.exe dist\\"
        - powershell -NoProfile -Command "Write-Output ('Packaged ' + $env:BIN + ' -> ' + 'dist\')"
        - powershell -Command Write-Output "Packaged $env:BIN $env:VERSION -> dist/"

  deploy:
    linux: &deploy_sh
      steps:
        - echo "Deploying…"
        - git add . || true
        - if git diff-index --quiet HEAD --; then echo "No changes to deploy. Skipping commit and push."; exit 0; fi
        - git commit -m "${COMMIT_MESSAGE:-Automated deployment commit}"
        - echo "Pushing to origin main…"
        - git push origin main
        - echo "Deploy complete."
    macos: *deploy_sh
    windows:
      steps:
        - echo "Deploying…"
        - git add .
        - powershell -NoProfile -Command "if ((git status --porcelain) -eq '') { Write-Host 'No changes to deploy. Skipping commit and push.'; exit 0 }"
        - powershell -Command "if (`$env:COMMIT_MESSAGE) { git commit -m `$env:COMMIT_MESSAGE } else { git commit -m 'Automated deployment commit' }"        
        - powershell -Command "Write-Host Pushing to origin main…"
        - powershell -Command "git push origin main"
        - powershell -Command "Write-Host Deploy complete."

  clean:
    linux: &clean_sh
      steps:
        - rm -rf target/ dist/
        - echo "Cleaned."
    macos: *clean_sh
    windows:
      steps:
        - rmdir /S /Q target 2>nul & rmdir /S /Q dist 2>nul & echo Cleaned.

blocks:
  build_common:
    steps:
      - rustc --version
      - cargo --version
      - cargo fmt --all -- --check
  test_cargo:
    steps:
      - cargo clippy --all-targets --all-features -- -D warnings
      - cargo test --all -- --nocapture

config:
  skip_sections:
    - predeploy
    - deploy
    - clean
  execution_policy: fast_fail
  env:
    BIN: zbuild
